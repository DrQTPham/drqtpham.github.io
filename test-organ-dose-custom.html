<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Organ Dose Custom Calculation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #5568d3;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        h2 {
            color: #667eea;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Organ Dose Custom Calculation</h1>

    <div class="test-box">
        <h2>Test Setup</h2>
        <div>
            <label>Select Organ:</label>
            <select id="testOrganSelector">
                <option value="">-- Select --</option>
                <option value="spinal_cord">Spinal Cord</option>
                <option value="brainstem">Brainstem</option>
                <option value="optic_nerve">Optic Nerve</option>
                <option value="lens">Lens</option>
                <option value="heart">Heart</option>
            </select>
        </div>
        <div style="margin-top: 10px;">
            <label>Custom Dose/Fraction (Gy):</label>
            <input type="number" id="testCustomDose" value="3.0" step="0.1" min="0.1">
        </div>
        <button onclick="runTest()">Run Test</button>
        <div id="test-result" class="result"></div>
    </div>

    <!-- Load required modules -->
    <script src="js/organ-dose-database.js"></script>
    <script src="js/bed-calculator.js"></script>
    <script src="js/validation-engine.js"></script>

    <script>
        // Mock currentSelectedOrgan
        let currentSelectedOrgan = null;

        function runTest() {
            const resultDiv = document.getElementById('test-result');
            const organId = document.getElementById('testOrganSelector').value;
            const customDose = parseFloat(document.getElementById('testCustomDose').value);

            try {
                // Set current organ
                currentSelectedOrgan = organId;

                // Get organ
                const organ = getOrgan(organId);
                if (!organ) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Organ not found: ' + organId;
                    return;
                }

                console.log('Organ:', organ);

                // Validate
                const validation = validationEngine.validateCalculationInputs({
                    organId: currentSelectedOrgan,
                    dosePerFraction: customDose
                });

                console.log('Validation:', validation);

                if (!validation.isValid) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå Validation failed: ' + validation.errorMessage;
                    return;
                }

                // Get conventional constraints
                if (!organ.conventional || organ.conventional.length === 0) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '‚ùå No conventional constraints for this organ';
                    return;
                }

                const alphaBeta = organ.alphaBeta;

                // Calculate for ALL constraints
                const results = organ.conventional.map(constraint => {
                    const result = bedCalculator.calculateDoseConversion({
                        referenceDose: constraint.doseLimit,
                        referenceFraction: 2.0,
                        customFraction: customDose,
                        alphaBeta: alphaBeta
                    });
                    
                    return {
                        constraint: constraint,
                        calculation: result
                    };
                });

                console.log('Results:', results);

                // Display results
                let output = `‚úÖ Test Passed!\n\n`;
                output += `Organ: ${organ.nameVi} (${organ.nameEn})\n`;
                output += `Œ±/Œ≤: ${alphaBeta} Gy\n`;
                output += `Custom Dose: ${customDose} Gy/fx\n\n`;
                output += `Constraints:\n`;

                results.forEach((item, index) => {
                    const c = item.constraint;
                    const calc = item.calculation;
                    
                    output += `\n${index + 1}. ${c.type} ${c.volume}:\n`;
                    output += `   Reference: ${calc.referenceDose.toFixed(1)} Gy (${calc.referenceFractions} fx)\n`;
                    output += `   Custom: ${calc.practicalDose.toFixed(1)} Gy (${calc.practicalFractions} fx)\n`;
                    output += `   BED Reference: ${calc.referenceBED.toFixed(1)} Gy\n`;
                    output += `   BED Custom: ${calc.customBED.toFixed(1)} Gy\n`;
                    output += `   Safety Margin: ${calc.safetyMargin.toFixed(1)}%\n`;
                    output += `   Status: ${calc.isWithinLimits ? '‚úÖ Safe' : '‚ùå Exceeded'}\n`;
                });

                resultDiv.className = 'result success';
                resultDiv.textContent = output;

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Error: ' + error.message + '\n\nStack:\n' + error.stack;
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
